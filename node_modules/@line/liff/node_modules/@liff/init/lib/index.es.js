import{__assign as e,__awaiter as t,__generator as r,__read as n}from"tslib";import{done as o}from"@liff/ready";import{convertHexToRgb as i,convertArgbToRgba as a,createLiffError as s,base64Url as l,convertArrayBuffer as c,compareVersion as u,qs as f,extractChannelIdFromLiffId as d,objectAssignKeyOnlyWithValue as h,addParamsToUrl as p,replaceUrlCredentialRemoved as v}from"@liff/util";import{getContext as m,getLoginTmp as w,getExpireTime as b,getIsSubsequentLiffApp as g,getFeatureToken as C,setIsSubsequentLiffApp as k,getMST as F,getAccessToken as _,getRawContext as y,getIDToken as B,getClientId as I,getMSTChallenge as S,getMSTVerifier as x,getMSIT as T,getConfig as A,setDecodedIDToken as D,setAppData as E,setMST as L,setFeatureToken as O,setAccessToken as U,setContext as P,setMSTChallenge as N,setMSTVerifier as K,setClientId as W,setMSIT as M,setIDToken as j,getDecodedIDToken as H,removeLoginTmp as V,setExpireTime as J,setConfig as q}from"@liff/store";import{load as R}from"@liff/extensions";import{INIT_FAILED as z,INVALID_ID_TOKEN as G,FORBIDDEN as Q,SUB_WINDOW_HEALTH_CHECK_MESSAGE as X,INVALID_CONFIG as Y}from"@liff/consts";import{isInClient as Z}from"@liff/is-in-client";import{isLoggedIn as $}from"@liff/is-logged-in";import{logout as ee}from"@liff/logout";import{isSubWindow as te}from"@liff/is-sub-window";import{getMSTByMSIT as re,getAppData as ne,getMainWindowOrigin as oe,setMainWindowOrigin as ie}from"@liff/sub-window";import{fetch as ae,getEndPoint as se,verifyAccessToken as le}from"@liff/server-api";import ce from"js-crypto-ec";import{getOS as ue}from"@liff/get-os";import{logger as fe}from"@liff/logger";import{getLineVersion as de}from"@liff/get-line-version";import{addListener as he,removeListener as pe}from"@liff/native-bridge";import{isApiAvailable as ve}from"@liff/is-api-available";var me={iconColor:"#111111",statusBarColor:"BLACK",titleTextColor:"#111111",titleSubtextColor:"#B7B7B7",titleButtonColor:"#111111",titleBackgroundColor:"#FFFFFF",progressBarColor:"#06C755",progressBackgroundColor:"#FFFFFF",titleButtonAreaBackgroundColor:"#1FFFFFFF",titleButtonAreaBorderColor:"#26000000",baseBackgroundColor:"#FFFFFF",baseTextColor:"#000000",lightButtonBorderColor:"rgba(0, 0, 0, 0.15)"},we={iconColor:"#FFFFFF",statusBarColor:"WHITE",titleTextColor:"#FFFFFF",titleSubtextColor:"#949494",titleButtonColor:"#FFFFFF",titleBackgroundColor:"#111111",progressBarColor:"#06C755",progressBackgroundColor:"#111111",titleButtonAreaBackgroundColor:"#1FFFFFFF",titleButtonAreaBorderColor:"#26000000",baseBackgroundColor:"#000000",baseTextColor:"#FFFFFF",lightButtonBorderColor:"rgba(255, 255, 255, 0.5)"};function be(){var e;ke("color-scheme",((null==(e=m())?void 0:e.menuColorSetting)||{adaptableColorSchemes:["light"]}).adaptableColorSchemes.join(" "));var t=window.matchMedia("(prefers-color-scheme: dark)");ge({matches:null==t?void 0:t.matches,media:null==t?void 0:t.media}),t.addEventListener?t.addEventListener("change",ge):t.addListener&&t.addListener(ge)}function ge(t){var r=m(),n=(null==r?void 0:r.menuColorSetting)||{adaptableColorSchemes:["light"],lightModeColor:me,darkModeColor:we},o=n.adaptableColorSchemes,i=n.lightModeColor,a=n.darkModeColor,s=o.includes("dark");t.matches&&s?Ce(e(e({},we),a)):Ce(e(e({},me),i))}function Ce(e){var t=e.iconColor,r=e.statusBarColor,n=e.titleTextColor,o=e.titleSubtextColor,s=e.titleButtonColor,l=e.titleBackgroundColor,c=e.progressBarColor,u=e.progressBackgroundColor,f=e.titleButtonAreaBackgroundColor,d=e.titleButtonAreaBorderColor,h=e.baseBackgroundColor,p=e.baseTextColor,v=e.lightButtonBorderColor;ke("--liff-base-background-color",h),ke("--liff-base-text-color",p),ke("--liff-base-background-rgb-color",i(h)),ke("--liff-base-text-rgb-color",i(p)),ke("--liff-light-button-border-color",v),ke("--liff-title-text-color",n),ke("--liff-title-background-color",l),ke("--liff-title-button-color",s),ke("--liff-icon-color",t),ke("--liff-status-bar-color",r),ke("--liff-title-subtext-color",o),ke("--liff-progress-bar-color",c),ke("--liff-progress-background-color",u),ke("--liff-title-button-area-background-color",a(f)),ke("--liff-title-button-area-border-color",a(d))}function ke(e,t){document.documentElement.style.setProperty(e,t)}function Fe(e){return t(this,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,R()];case 1:return t.sent().install(e),[2]}}))}))}function _e(){return t(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,ae(se("certs"))];case 1:return[2,e.sent()]}}))}))}var ye=function(){return"ios"===ue()&&(null!==(e=navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/))&&parseInt(e[1],10)<=10);var e};function Be(e,n,o){return t(this,void 0,void 0,(function(){var t,i;return r(this,(function(r){switch(r.label){case 0:return ye()?(t=ce.verify(n,o,e,"SHA-256","raw"),[3,4]):[3,1];case 1:return[4,crypto.subtle.importKey("jwk",e,{name:"ECDSA",namedCurve:"P-256"},!1,["verify"])];case 2:return i=r.sent(),[4,crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},i,o,n)];case 3:t=r.sent(),r.label=4;case 4:return[2,t]}}))}))}function Ie(e,o){return t(this,void 0,void 0,(function(){var t,i,a,u,f,d,h,p,v,m,w,b,g,C,k,F;return r(this,(function(r){switch(r.label){case 0:return t=e.split("."),i=n(t,3),a=i[0],u=i[1],f=i[2],d=JSON.parse(l.decode(a)),h=JSON.parse(l.decodeUnicode(u)),p=c(l.decode(f)),v=c(a+"."+u),[4,_e()];case 1:if(m=r.sent(),!(w=m.keys.find((function(e){return e.kid===d.kid}))))return[3,6];if(delete w.alg,"ES256"!==d.alg)throw s(G,'Invalid "alg" value in ID_TOKEN');b=void 0,r.label=2;case 2:return r.trys.push([2,4,,5]),[4,Be(w,v,p)];case 3:return b=r.sent(),[3,5];case 4:throw g=r.sent(),s(G,"Failed to use Crypto API to verify ID_TOKEN: "+g);case 5:if(b){if(C="https://access.line.me"!==h.iss,k=h.aud!==o,F=1e3*h.exp<Date.now(),C)throw s(G,'Invalid "iss" value in ID_TOKEN');if(k)throw s(G,'Invalid "aud" value in ID_TOKEN');if(F)throw s(G,'Invalid "exp" value in ID_TOKEN');return[2,h]}throw s(G,"Invalid signature in ID_TOKEN");case 6:throw s(G,'Invalid "kid" value in ID_TOKEN');case 7:return[2]}}))}))}function Se(e){var t=e.split(".");if(t[1])try{var r=t[1].replace(/-/g,"+").replace(/_/g,"/");return JSON.parse(window.atob(r))}catch(n){return null}return null}function xe(e){var t=e.pathname,r=e.query,n="liff://"+t+(r?"?"+f.stringify(r):"");location.href=n}var Te=null;function Ae(){"boolean"==typeof Te&&fe.warn("liff.init is not expected to be called more than once"),Te=!!g()||!(!Z()||f.parse(window.location.hash).feature_token||C())&&(k(!0),!0)}function De(){return Boolean(Te)}function Ee(e,n){return t(this,void 0,void 0,(function(){var t;return r(this,(function(r){switch(r.label){case 0:return(t=F())?[2,t]:e&&n?[4,re({msit:e,mstVerifier:n})]:[3,2];case 1:return[2,r.sent().mst];case 2:return[2,null]}}))}))}function Le(e){return ae(se("apps")+"/"+e+"/featureToken")}function Oe(e){return t(this,void 0,void 0,(function(){var t,n,o,i,a,s,l;return r(this,(function(r){switch(r.label){case 0:return t=f.parse(window.location.hash),n=h({access_token:_(),context_token:y(),feature_token:C(),id_token:B(),client_id:I(),mst_challenge:S(),mst_verifier:x(),msit:T()},t),De()?$()?[4,Le(e)]:[3,2]:[3,3];case 1:i=r.sent(),a=i.featureToken,s=i.features,o=s,n.feature_token||(n.feature_token=a),r.label=2;case 2:(l=d(e))&&(n.client_id=l),r.label=3;case 3:return[2,{credentials:n,features:o}]}}))}))}function Ue(e){if(e.persisted&&ve("multipleLiffTransition"))if("ios"===ue())window.location.reload();else{var t=A().liffId,r=C();if(!t)throw s(z,"Invalid LIFF ID.");if(!r)throw s(Q,"Invalid featureToken for client features");xe({pathname:"app/"+t,query:{feature_token:r}})}}function Pe(e,n){return t(this,void 0,void 0,(function(){var t,o;return r(this,(function(r){switch(r.label){case 0:return[4,le(e)];case 1:return t=r.sent().client_id,o=d(n),[2,t===o]}}))}))}function Ne(e,n){return t(this,void 0,void 0,(function(){var t,o,i,a,l,c,f,d,h,v,m,w,b;return r(this,(function(r){switch(r.label){case 0:return[4,new Promise((function(e){var t=de();if(!t||u(t,"9.5.0")<0)e();else if(window._liff&&window._liff.features)e();else{fe.debug("cannot find window._liff.features, listen to ready event");var r=function(){fe.debug("ready event is fired"),pe("ready",r),e()};he("ready",r)}}))];case 1:return r.sent(),Ae(),[4,Oe(n.liffId)];case 2:return t=r.sent().credentials,o=t.access_token,i=t.context_token,a=t.feature_token,l=t.id_token,c=t.client_id,f=t.mst_verifier,d=t.mst_challenge,h=t.msit,!te()&&a&&(!function(e,t){ve("multipleLiffTransition")&&xe({pathname:"app/"+e,query:{feature_token:t}})}(n.liffId,a),De()&&O(a)),i&&P(Se(i)),d&&N(d),f&&K(f),c&&W(c),h&&M(h),window.addEventListener("pageshow",Ue),$()?[3,7]:a&&o?[3,5]:De()?(v=p(location.href,{"liff.hback":"2"}),e.login({redirectUri:v}),[4,new Promise((function(){}))]):[3,4];case 3:r.sent(),r.label=4;case 4:throw e.login(),s(z,"Failed to parse feature_token or access_token");case 5:return[4,Pe(o,n.liffId)];case 6:if(!r.sent())throw e.login(),s(z,"Failed to verify access_token");O(a),U(o),r.label=7;case 7:return[4,Ee(h,f)];case 8:return(m=r.sent())?(L(m),[4,ne({mst:m})]):[3,10];case 9:(w=r.sent().data)&&E(JSON.stringify(w)),r.label=10;case 10:return l&&!B()&&j(l),l&&c&&!H()?[4,Ie(l,c)]:[3,12];case 11:(b=r.sent())&&D(b),r.label=12;case 12:return[2]}}))}))}function Ke(e){return t(this,void 0,void 0,(function(){var t,n,o,i,a,l,c;return r(this,(function(r){switch(r.label){case 0:return t=se("apps"),n=t+"/"+e+"/contextToken",o=_(),i={"Content-Type":"application/json",Accept:"application/json"},o&&(i.Authorization="Bearer "+o),[4,ae(n,{headers:i})];case 1:if(a=r.sent(),!(l=a.contextToken))throw s(z,"Can not get context from server.");if(!(c=Se(l)))throw s(z,"Invalid context token.");return[2,c]}}))}))}function We(){return t(this,void 0,void 0,(function(){var e,t;return r(this,(function(r){switch(r.label){case 0:if(!(e=A().liffId))throw s(z,"Invalid LIFF ID.");return[4,Ke(e)];case 1:return t=r.sent(),P(t),[2]}}))}))}function Me(e){return t(this,void 0,void 0,(function(){var n,o,i,a=this;return r(this,(function(s){switch(s.label){case 0:n=function(){return t(a,void 0,void 0,(function(){var t,n,o,i,a,s;return r(this,(function(r){switch(r.label){case 0:return[4,(l=A(),c=f.parse(window.location.search),u=w(),d={grant_type:"authorization_code",client_id:c.liffClientId,appId:l.liffId,code:c.code,code_verifier:u.codeVerifier,redirect_uri:l.redirectUri||c.liffRedirectUri,id_token_key_type:"JWK"},h=f.stringify(d),ae(se("token"),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:h}))];case 1:return t=r.sent(),n=t.access_token,o=t.id_token,i=t.expires_in,W(e),U(n),J(new Date(Date.now()+1e3*i)),V(),o?(j(o),[4,Ie(o,e)]):[3,3];case 2:(a=r.sent())&&D(a),r.label=3;case 3:return(s=f.parse(location.hash).context_token)?(P(Se(s)),[3,6]):[3,4];case 4:return[4,We()];case 5:r.sent(),r.label=6;case 6:return[2]}var l,c,u,d,h}))}))},s.label=1;case 1:return s.trys.push([1,3,,4]),[4,n()];case 2:return s.sent(),[3,4];case 3:throw o=s.sent(),i=o,V(),i;case 4:return[2]}}))}))}var je=new(function(){function e(){var e=this;this.getAndValidateContext=function(){var e=m();if(!e)throw s(z,"Could not get Context from server.");if(!e.endpointUrl)throw s(z,"Could not get endpointUrl from server.");if(!e.permanentLinkPattern)throw s(z,"Could not get permanentLinkPattern from server.");return e},this.decodeState=function(t){var r=e.getAndValidateContext();t=t.replace(/\n/g,"%0D%0A");var n=!r.endpointUrl.startsWith("/?")&&r.endpointUrl.includes("/?")||!r.endpointUrl.startsWith("/#")&&r.endpointUrl.includes("/#")||r.endpointUrl.endsWith("/")||!t.startsWith("/?")&&t.includes("/?")||!t.startsWith("/#")&&t.includes("/#")||t.endsWith("/"),o=new URL(r.endpointUrl),i=o.origin,a=o.pathname,s=o.search,l=new URL(""+i+e.attachSlashAtStart(t)),c=l.pathname,u=l.search,f=l.hash,d=""+s+(s?u.replace(/\?/g,"&"):u),h=(""+a+e.attachSlashAtStart(c)).replace("//","/");return(h=e.attachSlashAtStart(""+h)).endsWith("/")&&!n&&(h=h.substring(0,h.length-1)),(""+i+h+d+f).replace(/%0D%0A/g,"\n")}}return e.prototype.attachSlashAtStart=function(e){return(e&&e.length>0&&!e.startsWith("/")?"/":"")+e},e.prototype.invoke=function(){return t(this,void 0,void 0,(function(){var e,t,n,o,i;return r(this,(function(r){switch(r.label){case 0:if(e=f.parse(window.location.search),"string"!=typeof(t=e["liff.state"]))return[2];r.label=1;case 1:return r.trys.push([1,4,,5]),n=location.href,(o=this.decodeState(t))===n?[3,3]:(e["liff.hback"]?location.replace(p(o,{"liff.hback":e["liff.hback"]})):location.replace(o),[4,new Promise((function(){}))]);case 2:r.sent(),r.label=3;case 3:return[3,5];case 4:if((i=r.sent()).code===z)throw i;return fe.debug(i),[3,5];case 5:return[2]}}))}))},e}());function He(e,n,o){return t(this,void 0,void 0,(function(){var t;return r(this,(function(r){switch(r.label){case 0:if(!o.liffId)throw s(Y,"liffId is necessary for liff.init()");return q(o),!Z()&&$()&&(b()||ee()),t=f.parse(window.location.search),!te()||Z()?[3,2]:[4,new Promise((function(e){oe()?e():window.addEventListener("message",(function t(r){var n=r.data,o=r.source,i=r.origin;if(n){var a=n.type,s=n.message;a===X&&(window.removeEventListener("message",t),s&&E(s),ie(i),o&&o.postMessage&&o.postMessage({status:X},i),e())}}))}))];case 1:r.sent(),r.label=2;case 2:if(t.error&&t.liffOAuth2Error)throw l=t.error,c=t.error_description,u=c.replace(/\+/g," "),s(z,l+": "+u);return i=t.code,a=w(),Boolean(i&&!$()&&a&&a.codeVerifier)?[4,Me(t.liffClientId)]:[3,4];case 3:r.sent(),r.label=4;case 4:return Z()?[4,Ne(e,o)]:[3,6];case 5:return r.sent(),[3,8];case 6:return $()?[3,8]:[4,We()];case 7:r.sent(),r.label=8;case 8:return[4,je.invoke()];case 9:return r.sent(),[4,n.runHook("beforeInitFinished")];case 10:return r.sent(),v(window.location.href),[2]}var i,a,l,c,u}))}))}var Ve=function(){function e(e,t){this.liff=e,this.moduleDriver=t}return Object.defineProperty(e.prototype,"name",{get:function(){return"init"},enumerable:!1,configurable:!0}),e.prototype.install=function(){return this.init.bind(this)},e.prototype.init=function(e,n,i){return t(this,void 0,void 0,(function(){var t;return r(this,(function(r){switch(r.label){case 0:a=this.liff,window&&!window.liff&&(window.liff=a),r.label=1;case 1:return r.trys.push([1,4,,6]),[4,Promise.all([Fe(this.liff),He(this.liff,this.moduleDriver,e)])];case 2:return r.sent(),be(),[4,this.moduleDriver.runHook("beforeInitSuccess")];case 3:return r.sent(),"function"==typeof n&&n(),o(),[3,6];case 4:return t=r.sent(),[4,this.moduleDriver.runHook("initError",t)];case 5:throw r.sent(),"function"==typeof i&&i(t),t;case 6:return[2]}var a}))}))},e}();export{Ve as InitModule};
