"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("tslib"),t=require("@liff/ready"),r=require("@liff/util"),n=require("@liff/store"),o=require("@liff/extensions"),i=require("@liff/consts"),a=require("@liff/is-in-client"),s=require("@liff/is-logged-in"),l=require("@liff/logout"),c=require("@liff/is-sub-window"),f=require("@liff/sub-window"),u=require("@liff/server-api"),d=require("js-crypto-ec"),g=require("@liff/get-os"),h=require("@liff/logger"),_=require("@liff/get-line-version"),p=require("@liff/native-bridge"),v=require("@liff/is-api-available");function I(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var w=I(d),b={iconColor:"#111111",statusBarColor:"BLACK",titleTextColor:"#111111",titleSubtextColor:"#B7B7B7",titleButtonColor:"#111111",titleBackgroundColor:"#FFFFFF",progressBarColor:"#06C755",progressBackgroundColor:"#FFFFFF",titleButtonAreaBackgroundColor:"#1FFFFFFF",titleButtonAreaBorderColor:"#26000000",baseBackgroundColor:"#FFFFFF",baseTextColor:"#000000",lightButtonBorderColor:"rgba(0, 0, 0, 0.15)"},C={iconColor:"#FFFFFF",statusBarColor:"WHITE",titleTextColor:"#FFFFFF",titleSubtextColor:"#949494",titleButtonColor:"#FFFFFF",titleBackgroundColor:"#111111",progressBarColor:"#06C755",progressBackgroundColor:"#111111",titleButtonAreaBackgroundColor:"#1FFFFFFF",titleButtonAreaBorderColor:"#26000000",baseBackgroundColor:"#000000",baseTextColor:"#FFFFFF",lightButtonBorderColor:"rgba(255, 255, 255, 0.5)"};function F(){var e;m("color-scheme",((null==(e=n.getContext())?void 0:e.menuColorSetting)||{adaptableColorSchemes:["light"]}).adaptableColorSchemes.join(" "));var t=window.matchMedia("(prefers-color-scheme: dark)");T({matches:null==t?void 0:t.matches,media:null==t?void 0:t.media}),t.addEventListener?t.addEventListener("change",T):t.addListener&&t.addListener(T)}function T(t){var r=n.getContext(),o=(null==r?void 0:r.menuColorSetting)||{adaptableColorSchemes:["light"],lightModeColor:b,darkModeColor:C},i=o.adaptableColorSchemes,a=o.lightModeColor,s=o.darkModeColor,l=i.includes("dark");t.matches&&l?k(e.__assign(e.__assign({},C),s)):k(e.__assign(e.__assign({},b),a))}function k(e){var t=e.iconColor,n=e.statusBarColor,o=e.titleTextColor,i=e.titleSubtextColor,a=e.titleButtonColor,s=e.titleBackgroundColor,l=e.progressBarColor,c=e.progressBackgroundColor,f=e.titleButtonAreaBackgroundColor,u=e.titleButtonAreaBorderColor,d=e.baseBackgroundColor,g=e.baseTextColor,h=e.lightButtonBorderColor;m("--liff-base-background-color",d),m("--liff-base-text-color",g),m("--liff-base-background-rgb-color",r.convertHexToRgb(d)),m("--liff-base-text-rgb-color",r.convertHexToRgb(g)),m("--liff-light-button-border-color",h),m("--liff-title-text-color",o),m("--liff-title-background-color",s),m("--liff-title-button-color",a),m("--liff-icon-color",t),m("--liff-status-bar-color",n),m("--liff-title-subtext-color",i),m("--liff-progress-bar-color",l),m("--liff-progress-background-color",c),m("--liff-title-button-area-background-color",r.convertArgbToRgba(f)),m("--liff-title-button-area-border-color",r.convertArgbToRgba(u))}function m(e,t){document.documentElement.style.setProperty(e,t)}function L(t){return e.__awaiter(this,void 0,void 0,(function(){return e.__generator(this,(function(e){switch(e.label){case 0:return[4,o.load()];case 1:return e.sent().install(t),[2]}}))}))}function E(){return e.__awaiter(this,void 0,void 0,(function(){return e.__generator(this,(function(e){switch(e.label){case 0:return[4,u.fetch(u.getEndPoint("certs"))];case 1:return[2,e.sent()]}}))}))}var A=function(){return"ios"===g.getOS()&&(null!==(e=navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/))&&parseInt(e[1],10)<=10);var e};function D(t,r,n){return e.__awaiter(this,void 0,void 0,(function(){var o,i;return e.__generator(this,(function(e){switch(e.label){case 0:return A()?(o=w.default.verify(r,n,t,"SHA-256","raw"),[3,4]):[3,1];case 1:return[4,crypto.subtle.importKey("jwk",t,{name:"ECDSA",namedCurve:"P-256"},!1,["verify"])];case 2:return i=e.sent(),[4,crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},i,n,r)];case 3:o=e.sent(),e.label=4;case 4:return[2,o]}}))}))}function y(t,n){return e.__awaiter(this,void 0,void 0,(function(){var o,a,s,l,c,f,u,d,g,h,_,p,v,I,w,b;return e.__generator(this,(function(C){switch(C.label){case 0:return o=t.split("."),a=e.__read(o,3),s=a[0],l=a[1],c=a[2],f=JSON.parse(r.base64Url.decode(s)),u=JSON.parse(r.base64Url.decodeUnicode(l)),d=r.convertArrayBuffer(r.base64Url.decode(c)),g=r.convertArrayBuffer(s+"."+l),[4,E()];case 1:if(h=C.sent(),!(_=h.keys.find((function(e){return e.kid===f.kid}))))return[3,6];if(delete _.alg,"ES256"!==f.alg)throw r.createLiffError(i.INVALID_ID_TOKEN,'Invalid "alg" value in ID_TOKEN');p=void 0,C.label=2;case 2:return C.trys.push([2,4,,5]),[4,D(_,g,d)];case 3:return p=C.sent(),[3,5];case 4:throw v=C.sent(),r.createLiffError(i.INVALID_ID_TOKEN,"Failed to use Crypto API to verify ID_TOKEN: "+v);case 5:if(p){if(I="https://access.line.me"!==u.iss,w=u.aud!==n,b=1e3*u.exp<Date.now(),I)throw r.createLiffError(i.INVALID_ID_TOKEN,'Invalid "iss" value in ID_TOKEN');if(w)throw r.createLiffError(i.INVALID_ID_TOKEN,'Invalid "aud" value in ID_TOKEN');if(b)throw r.createLiffError(i.INVALID_ID_TOKEN,'Invalid "exp" value in ID_TOKEN');return[2,u]}throw r.createLiffError(i.INVALID_ID_TOKEN,"Invalid signature in ID_TOKEN");case 6:throw r.createLiffError(i.INVALID_ID_TOKEN,'Invalid "kid" value in ID_TOKEN');case 7:return[2]}}))}))}function S(e){var t=e.split(".");if(t[1])try{var r=t[1].replace(/-/g,"+").replace(/_/g,"/");return JSON.parse(window.atob(r))}catch(n){return null}return null}function B(e){var t=e.pathname,n=e.query,o="liff://"+t+(n?"?"+r.qs.stringify(n):"");location.href=o}var x=null;function N(){"boolean"==typeof x&&h.logger.warn("liff.init is not expected to be called more than once"),x=!!n.getIsSubsequentLiffApp()||!(!a.isInClient()||r.qs.parse(window.location.hash).feature_token||n.getFeatureToken())&&(n.setIsSubsequentLiffApp(!0),!0)}function O(){return Boolean(x)}function q(t,r){return e.__awaiter(this,void 0,void 0,(function(){var o;return e.__generator(this,(function(e){switch(e.label){case 0:return(o=n.getMST())?[2,o]:t&&r?[4,f.getMSTByMSIT({msit:t,mstVerifier:r})]:[3,2];case 1:return[2,e.sent().mst];case 2:return[2,null]}}))}))}function M(e){return u.fetch(u.getEndPoint("apps")+"/"+e+"/featureToken")}function U(t){return e.__awaiter(this,void 0,void 0,(function(){var o,i,a,l,c,f,u;return e.__generator(this,(function(e){switch(e.label){case 0:return o=r.qs.parse(window.location.hash),i=r.objectAssignKeyOnlyWithValue({access_token:n.getAccessToken(),context_token:n.getRawContext(),feature_token:n.getFeatureToken(),id_token:n.getIDToken(),client_id:n.getClientId(),mst_challenge:n.getMSTChallenge(),mst_verifier:n.getMSTVerifier(),msit:n.getMSIT()},o),O()?s.isLoggedIn()?[4,M(t)]:[3,2]:[3,3];case 1:l=e.sent(),c=l.featureToken,f=l.features,a=f,i.feature_token||(i.feature_token=c),e.label=2;case 2:(u=r.extractChannelIdFromLiffId(t))&&(i.client_id=u),e.label=3;case 3:return[2,{credentials:i,features:a}]}}))}))}function K(e){if(e.persisted&&v.isApiAvailable("multipleLiffTransition"))if("ios"===g.getOS())window.location.reload();else{var t=n.getConfig().liffId,o=n.getFeatureToken();if(!t)throw r.createLiffError(i.INIT_FAILED,"Invalid LIFF ID.");if(!o)throw r.createLiffError(i.FORBIDDEN,"Invalid featureToken for client features");B({pathname:"app/"+t,query:{feature_token:o}})}}function P(t,n){return e.__awaiter(this,void 0,void 0,(function(){var o,i;return e.__generator(this,(function(e){switch(e.label){case 0:return[4,u.verifyAccessToken(t)];case 1:return o=e.sent().client_id,i=r.extractChannelIdFromLiffId(n),[2,o===i]}}))}))}function V(t,o){return e.__awaiter(this,void 0,void 0,(function(){var a,l,u,d,g,I,w,b,C,F,T,k,m;return e.__generator(this,(function(e){switch(e.label){case 0:return[4,new Promise((function(e){var t=_.getLineVersion();if(!t||r.compareVersion(t,"9.5.0")<0)e();else if(window._liff&&window._liff.features)e();else{h.logger.debug("cannot find window._liff.features, listen to ready event");var n=function(){h.logger.debug("ready event is fired"),p.removeListener("ready",n),e()};p.addListener("ready",n)}}))];case 1:return e.sent(),N(),[4,U(o.liffId)];case 2:return a=e.sent().credentials,l=a.access_token,u=a.context_token,d=a.feature_token,g=a.id_token,I=a.client_id,w=a.mst_verifier,b=a.mst_challenge,C=a.msit,!c.isSubWindow()&&d&&(!function(e,t){v.isApiAvailable("multipleLiffTransition")&&B({pathname:"app/"+e,query:{feature_token:t}})}(o.liffId,d),O()&&n.setFeatureToken(d)),u&&n.setContext(S(u)),b&&n.setMSTChallenge(b),w&&n.setMSTVerifier(w),I&&n.setClientId(I),C&&n.setMSIT(C),window.addEventListener("pageshow",K),s.isLoggedIn()?[3,7]:d&&l?[3,5]:O()?(F=r.addParamsToUrl(location.href,{"liff.hback":"2"}),t.login({redirectUri:F}),[4,new Promise((function(){}))]):[3,4];case 3:e.sent(),e.label=4;case 4:throw t.login(),r.createLiffError(i.INIT_FAILED,"Failed to parse feature_token or access_token");case 5:return[4,P(l,o.liffId)];case 6:if(!e.sent())throw t.login(),r.createLiffError(i.INIT_FAILED,"Failed to verify access_token");n.setFeatureToken(d),n.setAccessToken(l),e.label=7;case 7:return[4,q(C,w)];case 8:return(T=e.sent())?(n.setMST(T),[4,f.getAppData({mst:T})]):[3,10];case 9:(k=e.sent().data)&&n.setAppData(JSON.stringify(k)),e.label=10;case 10:return g&&!n.getIDToken()&&n.setIDToken(g),g&&I&&!n.getDecodedIDToken()?[4,y(g,I)]:[3,12];case 11:(m=e.sent())&&n.setDecodedIDToken(m),e.label=12;case 12:return[2]}}))}))}function W(t){return e.__awaiter(this,void 0,void 0,(function(){var o,a,s,l,c,f,d;return e.__generator(this,(function(e){switch(e.label){case 0:return o=u.getEndPoint("apps"),a=o+"/"+t+"/contextToken",s=n.getAccessToken(),l={"Content-Type":"application/json",Accept:"application/json"},s&&(l.Authorization="Bearer "+s),[4,u.fetch(a,{headers:l})];case 1:if(c=e.sent(),!(f=c.contextToken))throw r.createLiffError(i.INIT_FAILED,"Can not get context from server.");if(!(d=S(f)))throw r.createLiffError(i.INIT_FAILED,"Invalid context token.");return[2,d]}}))}))}function H(){return e.__awaiter(this,void 0,void 0,(function(){var t,o;return e.__generator(this,(function(e){switch(e.label){case 0:if(!(t=n.getConfig().liffId))throw r.createLiffError(i.INIT_FAILED,"Invalid LIFF ID.");return[4,W(t)];case 1:return o=e.sent(),n.setContext(o),[2]}}))}))}function R(t){return e.__awaiter(this,void 0,void 0,(function(){var o,i,a,s=this;return e.__generator(this,(function(l){switch(l.label){case 0:o=function(){return e.__awaiter(s,void 0,void 0,(function(){var o,i,a,s,l,c;return e.__generator(this,(function(e){switch(e.label){case 0:return[4,(f=n.getConfig(),d=r.qs.parse(window.location.search),g=n.getLoginTmp(),h={grant_type:"authorization_code",client_id:d.liffClientId,appId:f.liffId,code:d.code,code_verifier:g.codeVerifier,redirect_uri:f.redirectUri||d.liffRedirectUri,id_token_key_type:"JWK"},_=r.qs.stringify(h),u.fetch(u.getEndPoint("token"),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:_}))];case 1:return o=e.sent(),i=o.access_token,a=o.id_token,s=o.expires_in,n.setClientId(t),n.setAccessToken(i),n.setExpireTime(new Date(Date.now()+1e3*s)),n.removeLoginTmp(),a?(n.setIDToken(a),[4,y(a,t)]):[3,3];case 2:(l=e.sent())&&n.setDecodedIDToken(l),e.label=3;case 3:return(c=r.qs.parse(location.hash).context_token)?(n.setContext(S(c)),[3,6]):[3,4];case 4:return[4,H()];case 5:e.sent(),e.label=6;case 6:return[2]}var f,d,g,h,_}))}))},l.label=1;case 1:return l.trys.push([1,3,,4]),[4,o()];case 2:return l.sent(),[3,4];case 3:throw i=l.sent(),a=i,n.removeLoginTmp(),a;case 4:return[2]}}))}))}var j=new(function(){function t(){var e=this;this.getAndValidateContext=function(){var e=n.getContext();if(!e)throw r.createLiffError(i.INIT_FAILED,"Could not get Context from server.");if(!e.endpointUrl)throw r.createLiffError(i.INIT_FAILED,"Could not get endpointUrl from server.");if(!e.permanentLinkPattern)throw r.createLiffError(i.INIT_FAILED,"Could not get permanentLinkPattern from server.");return e},this.decodeState=function(t){var r=e.getAndValidateContext();t=t.replace(/\n/g,"%0D%0A");var n=!r.endpointUrl.startsWith("/?")&&r.endpointUrl.includes("/?")||!r.endpointUrl.startsWith("/#")&&r.endpointUrl.includes("/#")||r.endpointUrl.endsWith("/")||!t.startsWith("/?")&&t.includes("/?")||!t.startsWith("/#")&&t.includes("/#")||t.endsWith("/"),o=new URL(r.endpointUrl),i=o.origin,a=o.pathname,s=o.search,l=new URL(""+i+e.attachSlashAtStart(t)),c=l.pathname,f=l.search,u=l.hash,d=""+s+(s?f.replace(/\?/g,"&"):f),g=(""+a+e.attachSlashAtStart(c)).replace("//","/");return(g=e.attachSlashAtStart(""+g)).endsWith("/")&&!n&&(g=g.substring(0,g.length-1)),(""+i+g+d+u).replace(/%0D%0A/g,"\n")}}return t.prototype.attachSlashAtStart=function(e){return(e&&e.length>0&&!e.startsWith("/")?"/":"")+e},t.prototype.invoke=function(){return e.__awaiter(this,void 0,void 0,(function(){var t,n,o,a,s;return e.__generator(this,(function(e){switch(e.label){case 0:if(t=r.qs.parse(window.location.search),"string"!=typeof(n=t["liff.state"]))return[2];e.label=1;case 1:return e.trys.push([1,4,,5]),o=location.href,(a=this.decodeState(n))===o?[3,3]:(t["liff.hback"]?location.replace(r.addParamsToUrl(a,{"liff.hback":t["liff.hback"]})):location.replace(a),[4,new Promise((function(){}))]);case 2:e.sent(),e.label=3;case 3:return[3,5];case 4:if((s=e.sent()).code===i.INIT_FAILED)throw s;return h.logger.debug(s),[3,5];case 5:return[2]}}))}))},t}());function J(t,o,u){return e.__awaiter(this,void 0,void 0,(function(){var d;return e.__generator(this,(function(e){switch(e.label){case 0:if(!u.liffId)throw r.createLiffError(i.INVALID_CONFIG,"liffId is necessary for liff.init()");return n.setConfig(u),!a.isInClient()&&s.isLoggedIn()&&(n.getExpireTime()||l.logout()),d=r.qs.parse(window.location.search),!c.isSubWindow()||a.isInClient()?[3,2]:[4,new Promise((function(e){f.getMainWindowOrigin()?e():window.addEventListener("message",(function t(r){var o=r.data,a=r.source,s=r.origin;if(o){var l=o.type,c=o.message;l===i.SUB_WINDOW_HEALTH_CHECK_MESSAGE&&(window.removeEventListener("message",t),c&&n.setAppData(c),f.setMainWindowOrigin(s),a&&a.postMessage&&a.postMessage({status:i.SUB_WINDOW_HEALTH_CHECK_MESSAGE},s),e())}}))}))];case 1:e.sent(),e.label=2;case 2:if(d.error&&d.liffOAuth2Error)throw _=d.error,p=d.error_description,v=_+": "+p.replace(/\+/g," "),r.createLiffError(i.INIT_FAILED,v);return g=d.code,h=n.getLoginTmp(),Boolean(g&&!s.isLoggedIn()&&h&&h.codeVerifier)?[4,R(d.liffClientId)]:[3,4];case 3:e.sent(),e.label=4;case 4:return a.isInClient()?[4,V(t,u)]:[3,6];case 5:return e.sent(),[3,8];case 6:return s.isLoggedIn()?[3,8]:[4,H()];case 7:e.sent(),e.label=8;case 8:return[4,j.invoke()];case 9:return e.sent(),[4,o.runHook("beforeInitFinished")];case 10:return e.sent(),r.replaceUrlCredentialRemoved(window.location.href),[2]}var g,h,_,p,v}))}))}var G=function(){function r(e,t){this.liff=e,this.moduleDriver=t}return Object.defineProperty(r.prototype,"name",{get:function(){return"init"},enumerable:!1,configurable:!0}),r.prototype.install=function(){return this.init.bind(this)},r.prototype.init=function(r,n,o){return e.__awaiter(this,void 0,void 0,(function(){var i;return e.__generator(this,(function(e){switch(e.label){case 0:a=this.liff,window&&!window.liff&&(window.liff=a),e.label=1;case 1:return e.trys.push([1,4,,6]),[4,Promise.all([L(this.liff),J(this.liff,this.moduleDriver,r)])];case 2:return e.sent(),F(),[4,this.moduleDriver.runHook("beforeInitSuccess")];case 3:return e.sent(),"function"==typeof n&&n(),t.done(),[3,6];case 4:return i=e.sent(),[4,this.moduleDriver.runHook("initError",i)];case 5:throw e.sent(),"function"==typeof o&&o(i),i;case 6:return[2]}var a}))}))},r}();exports.InitModule=G;
